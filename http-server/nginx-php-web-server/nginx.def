Bootstrap: library
From: ubuntu:16.04

%help
Usage: sudo singularity instance start \
 -B nginx/log/error.log:/var/log/nginx/error.log \
 -B nginx/log/access.log:/var/log/nginx/access.log \
 -B nginx/run/nginx.pid:/run/nginx.pid \
 -B nginx/lib/:/var/lib/nginx/ \
 -B nginx/favicon.ico:/usr/share/nginx/html/favicon.ico \
 -B nginx/www/html/index.php:/var/www/html/index.php \
 -B nginx/tmp/data.txt:/tmp/data.txt \
 -B php/php.ini:/etc/php/7.0/fpm/php.ini \
 -B php/:/run/php \
 -B php/log/php7.0-fpm.log:/var/log/php7.0-fpm.log \
 nginx.sif nginx php

%startscript
nginx -t
/etc/init.d/php7.0-fpm restart
/etc/init.d/nginx restart

%post
apt-get -y update
apt-get -y install nginx
apt-get -y install php-fpm php-mysql

cat << EOF > /etc/nginx/sites-available/default 

server {
        listen 80 default_server;
        listen [::]:80 default_server;

        root /var/www/html;

        index index.php index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
            try_files $uri $uri/ =404;
        }

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
        	fastcgi_pass unix:/run/php/php7.0-fpm.sock;
    	}

	    location ~ /\.ht {
    	    deny all;
    	}

}

EOF
