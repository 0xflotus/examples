Bootstrap: library
From: alpine:3.8

%environment

  RABBITMQ_LOGS=-
  RABBITMQ_SASL_LOGS=-
  RABBITMQ_HOME=/opt/rabbitmq
  PATH=$RABBITMQ_HOME/sbin:$PATH
  RABBITMQ_GPG_KEY=0A9AF2115F4687BD29803A206B73A36E6026DFCA
  RABBITMQ_VERSION=3.7.8-rc.4
  RABBITMQ_GITHUB_TAG=v3.7.8-rc.4
  RABBITMQ_ERLANG_COOKIE=/var/lib/rabbitmq
  HOME=/var/lib/rabbitmq

  export RABBITMQ_LOGS RABBITMQ_SASL_LOGS RABBITMQ_HOME PATH RABBITMQ_GITHUB_TAG HOME RABBITMQ_ERLANG_COOKIE

%help

	Singularity container with RabbitMQ message broker for Alpine 3.8.

%post

  #Exporting all this stuff because on the env it is done later...
  RABBITMQ_LOGS=-
  RABBITMQ_SASL_LOGS=-
  RABBITMQ_HOME=/opt/rabbitmq
  PATH=$RABBITMQ_HOME/sbin:$PATH
  RABBITMQ_GPG_KEY=0A9AF2115F4687BD29803A206B73A36E6026DFCA
  RABBITMQ_VERSION=3.7.8
  RABBITMQ_GITHUB_TAG=v3.7.8
  HOME=/var/lib/rabbitmq
  RABBITMQ_ERLANG_COOKIE=/var/lib/rabbitmq

  export RABBITMQ_LOGS RABBITMQ_SASL_LOGS RABBITMQ_HOME PATH RABBITMQ_GITHUB_TAG HOME RABBITMQ_ERLANG_COOKIE

  apk add ca-certificates libressl wget xz gnupg git
  apk add procps erlang-asn1 erlang-hipe erlang-crypto erlang-eldap erlang-inets erlang-mnesia erlang erlang-os-mon erlang-os-mon erlang-public-key erlang-sasl erlang-ssl erlang-syntax-tools erlang-xmerl

  wget -O rabbitmq-server.tar.xz.asc "https://github.com/rabbitmq/rabbitmq-server/releases/download/$RABBITMQ_GITHUB_TAG/rabbitmq-server-generic-unix-${RABBITMQ_VERSION}.tar.xz.asc"
  wget -O rabbitmq-server.tar.xz     "https://github.com/rabbitmq/rabbitmq-server/releases/download/$RABBITMQ_GITHUB_TAG/rabbitmq-server-generic-unix-${RABBITMQ_VERSION}.tar.xz"

  export GNUPGHOME="$(mktemp -d)"
	gpg --keyserver ha.pool.sks-keyservers.net --recv-keys "$RABBITMQ_GPG_KEY"
	gpg --batch --verify rabbitmq-server.tar.xz.asc rabbitmq-server.tar.xz
	command -v gpgconf && gpgconf --kill all || :
	rm -rf "$GNUPGHOME"

  mkdir -p "$RABBITMQ_HOME"

	tar --extract --verbose --file rabbitmq-server.tar.xz --directory "$RABBITMQ_HOME" --strip-components 1
	rm -f rabbitmq-server.tar.xz*

# update SYS_PREFIX (first making sure it's set to what we expect it to be)
	grep -qE '^SYS_PREFIX=\$\{RABBITMQ_HOME\}$' "$RABBITMQ_HOME/sbin/rabbitmq-defaults"
	sed -ri 's!^(SYS_PREFIX=).*$!\1!g' "$RABBITMQ_HOME/sbin/rabbitmq-defaults"
	grep -qE '^SYS_PREFIX=$' "$RABBITMQ_HOME/sbin/rabbitmq-defaults"

  mkdir -p /var/lib/rabbitmq /etc/rabbitmq /var/log/rabbitmq /tmp/rabbitmq-ssl
	chown -R root:root /var/lib/rabbitmq /etc/rabbitmq /var/log/rabbitmq /tmp/rabbitmq-ssl
  chmod -R 777 /var/lib/rabbitmq /etc/rabbitmq /var/log/rabbitmq /tmp/rabbitmq-ssl

%startscript

  # Start the server instance by default on localhost:6379
  rabbitmq-server
